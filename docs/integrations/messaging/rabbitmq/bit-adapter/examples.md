---
sidebar_position: 4
---

# Примеры использования

Примеры реализации интеграции с RabbitMQ с использованием БИТ.Адаптера.

## Регистрация модуля с подписками

В модуле `адаптер_ИнтеграцияПроектный` регистрируются модули, которые будут обрабатывать события адаптера:

```bsl
#Область ПрограммныйИнтерфейс

// Вызывается при определении модулей с подписками на события.
//
// Параметры:
//   МодулиСПодписками - Массив из ОбщийМодуль - модули с подписками.
//
Процедура ПриОпределенииМодулейСПодписками(МодулиСПодписками) Экспорт
    МодулиСПодписками.Добавить(адаптерпроект_ИнтеграцияАдаптер);
КонецПроцедуры

#КонецОбласти
```

## Подписка на события

В модуле `адаптерпроект_ИнтеграцияАдаптер` указываются подписки, которые будут обрабатываться:

```bsl
// Вызывается при определении состава подписок.
//
// Параметры:
//   Подписки - Структура - см. адаптер_Интеграция.ВсеПодписки().
//
Процедура Подписаться(Подписки) Экспорт
    // Выгрузка данных
    Подписки.ЗаполнитьВыгружаемыеОбъекты = Истина;
    Подписки.ПолучитьДанныеВыгружаемогоОбъекта = Истина;
    Подписки.ЗаполнитьСоставВыгружаемыхОбъектов = Истина;
    Подписки.ЗаполнитьТекстыЗапросовУсловиями = Истина;
    Подписки.ПередЗаписьюДокумента = Истина;

    // Загрузка данных
    Подписки.ЗаполнитьЗагружаемыеОбъекты = Истина;
    Подписки.ЗаполнитьЗагружаемыйОбъект = Истина;
    Подписки.ЗаписатьМассивДанных = Истина;
    Подписки.НайтиСсылкуПоЗагружаемымДанным = Истина;
    Подписки.ЗаписатьЗагружаемыйОбъект = Истина;
КонецПроцедуры
```

## Определение выгружаемых объектов

### Таблица выгружаемых объектов

```bsl
Функция ВыгружаемыеОбъекты()
    ВыгружаемыеОбъекты = Новый ТаблицаЗначений;
    ВыгружаемыеОбъекты.Колонки.Добавить("Метаданные");
    ВыгружаемыеОбъекты.Колонки.Добавить("Type");
    ВыгружаемыеОбъекты.Колонки.Добавить("ФорматСообщений");

    // Справочники
    ДобавитьВыгружаемыйОбъект(ВыгружаемыеОбъекты,
        Метаданные.Справочники.ОсновныеСредства,
        Перечисления.адаптер_ФорматыСообщений.JSONMobile);

    // Документы
    ДобавитьВыгружаемыйОбъект(ВыгружаемыеОбъекты,
        Метаданные.Документы.ПринятиеКУчетуОС,
        Перечисления.адаптер_ФорматыСообщений.JSONMobile);
    ДобавитьВыгружаемыйОбъект(ВыгружаемыеОбъекты,
        Метаданные.Документы.СписаниеОС,
        Перечисления.адаптер_ФорматыСообщений.JSONMobile);

    Возврат ВыгружаемыеОбъекты;
КонецФункции

Процедура ДобавитьВыгружаемыйОбъект(ВыгружаемыеОбъекты, МетаданныеОбъекта, ФорматСообщений = Неопределено)
    ВыгружаемыйОбъект = ВыгружаемыеОбъекты.Добавить();
    ВыгружаемыйОбъект.Метаданные = МетаданныеОбъекта;
    ВыгружаемыйОбъект.Type = МетаданныеОбъекта.ПолноеИмя();
    ВыгружаемыйОбъект.ФорматСообщений = ФорматСообщений;
КонецПроцедуры
```

### Заполнение настроек выгрузки

```bsl
Процедура ЗаполнитьВыгружаемыеОбъекты(ПараметрыПодключения, НастройкиВыгрузки, СтандартнаяОбработка) Экспорт
    Для Каждого ВыгружаемыйОбъект Из ВыгружаемыеОбъекты() Цикл
        адаптер_НастройкиОбмена.ДобавитьНастройку(НастройкиВыгрузки,
            ВыгружаемыйОбъект.Метаданные,
            ПараметрыПодключения,
            ВыгружаемыйОбъект.ФорматСообщений,,,
            ВыгружаемыйОбъект.Type);
    КонецЦикла;
КонецПроцедуры
```

## Настройка состава выгружаемых реквизитов

Позволяет ограничить набор реквизитов, переименовать или добавить новые:

```bsl
Процедура ЗаполнитьСоставВыгружаемыхОбъектов(РеквизитыИСвойства, ФорматСообщения, ПространствоИмен) Экспорт

    Если РеквизитыИСвойства.МетаданныеОбъекта = Метаданные.Справочники.ОсновныеСредства Тогда
        // Переименование реквизита для базы-приёмника
        адаптер_НастройкиОбмена.ДобавитьРеквизит(РеквизитыИСвойства,
            Метаданные.Справочники.ОсновныеСредства, "Код", "ИнвентарныйНомерМСФО");

        // Удаление ненужных реквизитов
        адаптер_НастройкиОбмена.УдалитьРеквизит(РеквизитыИСвойства,
            Метаданные.Справочники.ОсновныеСредства, "Изготовитель");
        адаптер_НастройкиОбмена.УдалитьРеквизит(РеквизитыИСвойства,
            Метаданные.Справочники.ОсновныеСредства, "Родитель");
    КонецЕсли;

    Если РеквизитыИСвойства.МетаданныеОбъекта = Метаданные.Документы.ПринятиеКУчетуОС Тогда
        // Оставляем только нужные реквизиты
        адаптер_НастройкиОбмена.ОставитьРеквизиты(РеквизитыИСвойства,
            Метаданные.Документы.ПринятиеКУчетуОС,
            "ВидОперации,Проведен,ПометкаУдаления,Дата,Организация,
            |ОС.ОсновноеСредство,ОС.ПервоначальнаяСтоимостьБУ,
            |ОС.СрокПолезногоИспользованияБУ,ОС.ПодразделениеОрганизации");

        // Переименование реквизитов табличной части
        адаптер_НастройкиОбмена.ДобавитьРеквизит(РеквизитыИСвойства,
            Метаданные.Документы.ПринятиеКУчетуОС, "ОС.ОсновноеСредство", "ОС.ВНА");
        адаптер_НастройкиОбмена.ДобавитьРеквизит(РеквизитыИСвойства,
            Метаданные.Документы.ПринятиеКУчетуОС, "ОС.ПодразделениеОрганизации", "ОС.ккЦФО");
    КонецЕсли;

КонецПроцедуры
```

## Фильтрация данных при выгрузке

Добавление условий в запросы для фильтрации выгружаемых данных:

```bsl
Процедура ЗаполнитьТекстыЗапросовУсловиями(ТекстЗапроса, ТекстЗапросаТаблицаКлючей,
    ПараметрыЗапроса, НастройкаВыгрузки, Объект, СтандартнаяОбработка) Экспорт

    // Фильтрация по виду операции для документа ПринятиеКУчетуОС
    Если НастройкаВыгрузки.МетаданныеОбъекта = Метаданные.Документы.ПринятиеКУчетуОС Тогда
        ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
            "&УсловиеЗапроса",
            "(ВыгружаемыйОбъект.ВидОперации = Значение(Перечисление.ВидыОперацийПринятияКУчетуОсновныхСредств.Оборудование)
            |ИЛИ
            |ВыгружаемыйОбъект.ВидОперации = Значение(Перечисление.ВидыОперацийПринятияКУчетуОсновныхСредств.ОбъектыСтроительства))
            |И &УсловиеЗапроса");
    КонецЕсли;

    // Фильтрация перемещений только при смене подразделения
    Если НастройкаВыгрузки.МетаданныеОбъекта = Метаданные.Документы.ПеремещениеОС Тогда
        ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
            "&УсловиеЗапроса",
            "ВыгружаемыйОбъект.ОС.ПодразделениеОрганизации <> ВыгружаемыйОбъект.ОС.НовыйПодразделениеОрганизации
            |И &УсловиеЗапроса");
    КонецЕсли;

КонецПроцедуры
```

## Получение данных объекта для выгрузки

```bsl
Функция ПолучитьДанныеВыгружаемогоОбъекта(Объект, ДанныеСообщения) Экспорт
    Результат = Неопределено;
    ТипОбъекта = ТипЗнч(Объект);

    Если ТипОбъекта = Тип("СправочникОбъект._ДемоПроекты")
        ИЛИ ТипОбъекта = Тип("СправочникСсылка._ДемоПроекты") Тогда

        // Стандартное получение данных
        Результат = адаптер_РаботаСДаннымиИБ.ПолучитьДанныеВыгружаемогоОбъекта(Объект, ДанныеСообщения);
    КонецЕсли;

    Возврат Результат;
КонецФункции
```

## Определение загружаемых объектов

```bsl
Процедура ЗаполнитьЗагружаемыеОбъекты(МассивЗагружаемыхОбъектов, СтандартнаяОбработка) Экспорт

    // Справочники
    МассивЗагружаемыхОбъектов.Добавить("json.Справочник.ОсновныеСредства");

    // Документы
    МассивЗагружаемыхОбъектов.Добавить("json.Документ.ПринятиеКУчетуОС");
    МассивЗагружаемыхОбъектов.Добавить("json.Документ.СписаниеОС");
    МассивЗагружаемыхОбъектов.Добавить("json.Документ.ПеремещениеОС");
    МассивЗагружаемыхОбъектов.Добавить("json.Документ.ПередачаОС");
    МассивЗагружаемыхОбъектов.Добавить("json.Документ.МодернизацияОС");
    МассивЗагружаемыхОбъектов.Добавить("json.Документ.ЗакрытиеМесяца");

КонецПроцедуры
```

## Запись входящих данных

### Маршрутизация по типу данных

```bsl
Функция ЗаписатьМассивДанных(ДанныеОбъекта) Экспорт
    Результат = Неопределено;

    ТипДанных = ДанныеОбъекта.Type;

    Если ТипДанных = "справочник.ОсновныеСредства" Тогда
        Результат = ЗаписатьСправочник_ОсновныеСредства(ДанныеОбъекта);
    ИначеЕсли ТипДанных = "документ.ПринятиеКУчетуОС" Тогда
        Результат = ЗаписатьДокумент_ПринятиеКУчетуОС(ДанныеОбъекта);
    КонецЕсли;

    Возврат Результат;
КонецФункции
```

### Пример загрузки справочника

```bsl
Функция ЗаписатьСправочник_ДемоПроекты(ДанныеОбъекта) Экспорт

    Результат = Новый Структура("Успешно, МассивЗагруженныхОбъектов", Ложь, Новый Массив);
    ОшибкиЗагрузки = "";
    СтруктураДанных = ДанныеОбъекта.data;
    Идентификатор = ДанныеОбъекта.data;

    // Поиск существующего объекта по внешнему идентификатору
    ЗагружаемаяСсылка = адаптерпроект_РаботаСДаннымиИБ.НайтиОбъектПоВнешнемуИдентификатору(
        Идентификатор, "Справочник._ДемоПроекты", Ложь);

    Если ЗначениеЗаполнено(ЗагружаемаяСсылка) Тогда
        ЗагружаемыйОбъект = ЗагружаемаяСсылка.ПолучитьОбъект();
        ЗагружаемыйОбъект.УстановитьПометкуУдаления(Ложь);
    Иначе
        ЗагружаемыйОбъект = Справочники._ДемоПроекты.СоздатьЭлемент();
    КонецЕсли;

    // Конвертация данных из внешнего формата
    СтруктураСконвертированныхДанных = Новый Структура;
    СтруктураСконвертированныхДанных.Вставить("Наименование", СтруктураДанных.Name);
    СтруктураСконвертированныхДанных.Вставить("Организация",
        адаптерпроект_РаботаСДаннымиИБ.НайтиЭлементСправочникаПоИдентификатору(
            СтруктураДанных, "guidOrganizations", "_ДемоОрганизации", ОшибкиЗагрузки));

    // Запись объекта
    Если ОшибкиЗагрузки = "" Тогда
        ЗаполнитьЗначенияСвойств(ЗагружаемыйОбъект, СтруктураСконвертированныхДанных);
        адаптер_ОбработчикиСобытийОбщий.ЗаписатьЗагружаемыйОбъект(ЗагружаемыйОбъект);

        Результат.Успешно = Истина;
        Результат.СобытиеСообщения = ПредопределенноеЗначение("Перечисление.адаптер_СобытияСообщений.Обработано");
        Результат.МассивЗагруженныхОбъектов.Добавить(ЗагружаемыйОбъект.Ссылка);
    Иначе
        Результат.Успешно = Ложь;
        Результат.ТекстОшибки = ОшибкиЗагрузки;
        Результат.СобытиеСообщения = ПредопределенноеЗначение("Перечисление.адаптер_СобытияСообщений.Ошибка");
    КонецЕсли;

    Возврат Результат;

КонецФункции
```

## Вспомогательные функции

### Поиск объекта по внешнему идентификатору

```bsl
Функция НайтиОбъектПоВнешнемуИдентификатору(Идентификатор, ТипОбъекта, СообщатьОбОшибке = Ложь) Экспорт

    ТекстЗапроса =
        "ВЫБРАТЬ ПЕРВЫЕ 1
        |   ОсновнаяТаблица.Ссылка КАК Ссылка
        |ИЗ
        |   " + ТипОбъекта + " КАК ОсновнаяТаблица
        |ГДЕ
        |   ОсновнаяТаблица.ВнешнийИдентификатор = &Идентификатор";

    Запрос = Новый Запрос(ТекстЗапроса);
    Запрос.УстановитьПараметр("Идентификатор", Идентификатор);

    Выборка = Запрос.Выполнить().Выбрать();
    Если Выборка.Следующий() Тогда
        Возврат Выборка.Ссылка;
    КонецЕсли;

    Если СообщатьОбОшибке Тогда
        ШаблонОшибки = НСтр("ru = 'Не найден ""%1"" с внешним идентификатором ""%2""'");
        ТекстОшибки = СтрШаблон(ШаблонОшибки, ТипОбъекта, Идентификатор);
        ВызватьИсключение ТекстОшибки;
    КонецЕсли;

    Возврат Неопределено;

КонецФункции
```

### Поиск элемента справочника по идентификатору

```bsl
Функция НайтиЭлементСправочникаПоИдентификатору(СтруктураДанных, ИмяСвойства, ИмяСправочника, ОшибкиЗагрузки) Экспорт

    Идентификатор = "";

    Если Не СтруктураДанных.Свойство(ИмяСвойства, Идентификатор) Тогда
        ШаблонОшибки = НСтр("ru = 'В загружаемых данных не найдено свойство ""%1""'");
        ТекстОшибки = СтрШаблон(ШаблонОшибки, ИмяСвойства);
        ДобавитьЗамечание(ОшибкиЗагрузки, ТекстОшибки);
        Возврат Неопределено;
    КонецЕсли;

    Если Не ЗначениеЗаполнено(Идентификатор) Тогда
        ШаблонОшибки = НСтр("ru = 'В загружаемых данных не указано значение свойства ""%1""'");
        ТекстОшибки = СтрШаблон(ШаблонОшибки, ИмяСвойства);
        ДобавитьЗамечание(ОшибкиЗагрузки, ТекстОшибки);
        Возврат Неопределено;
    КонецЕсли;

    МенеджерСправочника = Справочники[ИмяСправочника];
    ИдентификаторОбъекта = Новый УникальныйИдентификатор(Идентификатор);
    СправочникСсылка = МенеджерСправочника.ПолучитьСсылку(ИдентификаторОбъекта);

    // Проверка существования или поиск через таблицу ключей
    Если НЕ ОбщегоНазначения.СсылкаСуществует(СправочникСсылка) Тогда
        СправочникСсылка = РегистрыСведений.адаптер_ТаблицаКлючей.ПолучитьСсылку(
            СправочникСсылка.Метаданные().ПолноеИмя(), Идентификатор);
    КонецЕсли;

    Если НЕ СправочникСсылка = Неопределено
        И ОбщегоНазначения.СсылкаСуществует(СправочникСсылка) Тогда
        Возврат СправочникСсылка;
    КонецЕсли;

    ШаблонОшибки = НСтр("ru = 'Не найден элемент справочника ""%1"" с идентификатором ""%2""'");
    ТекстОшибки = СтрШаблон(ШаблонОшибки, ИмяСправочника, Идентификатор);
    ДобавитьЗамечание(ОшибкиЗагрузки, ТекстОшибки);

    Возврат Неопределено;

КонецФункции
```

### Структура результата обработки

```bsl
Функция ПолучитьСтруктуруОбработкиВходящегоСообщения() Экспорт

    Результат = Новый Структура;
    Результат.Вставить("Успешно");
    Результат.Вставить("МассивЗагруженныхОбъектов");
    Результат.Вставить("СобытиеСообщения");
    Результат.Вставить("ТекстОшибки");

    Возврат Результат;

КонецФункции

Процедура ЗафиксироватьОшибкуОбработки(РезультатОбработки, ТекстОшибки) Экспорт

    РезультатОбработки.Успешно = Ложь;
    РезультатОбработки.СобытиеСообщения = ПредопределенноеЗначение("Перечисление.адаптер_СобытияСообщений.Ошибка");
    РезультатОбработки.ТекстОшибки = ТекстОшибки;

КонецПроцедуры
```

## Рекомендации

1. **Модульная структура** — разделяйте логику по общим модулям: основная интеграция, работа с данными ИБ, модули для каждого источника
2. **Форматы сообщений** — используйте `JSONMobile` для компактных сообщений или `адаптерXML` для полной совместимости
3. **Фильтрация данных** — используйте `ЗаполнитьТекстыЗапросовУсловиями` для ограничения выгружаемых данных
4. **Настройка состава** — используйте `ОставитьРеквизиты`, `ДобавитьРеквизит`, `УдалитьРеквизит` для оптимизации объёма данных
5. **Обработка ошибок** — всегда возвращайте структурированный результат с полями `Успешно`, `ТекстОшибки`, `СобытиеСообщения`
